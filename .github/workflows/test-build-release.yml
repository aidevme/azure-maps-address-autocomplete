name: Test, Build and Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  SOLUTION_NAME: AzureMapsAddressAutoComplete
  SOLUTION_FOLDER: Solution/AzureMapsAddressSolution

jobs:
  # ===========================================
  # Test Job - Runs unit tests
  # ===========================================
  test:
    name: Run Unit Tests
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: Run unit tests
        run: npm test -- --ci --coverage

  # ===========================================
  # Build Job - Runs on every push and PR
  # ===========================================
  build:
    name: Build PCF Control
    needs: test
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Build PCF control
        run: npm run build

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      - name: Install Power Platform CLI
        run: dotnet tool install --global Microsoft.PowerApps.CLI.Tool

      - name: Verify Solution folder exists
        run: |
          if (!(Test-Path -Path "${{ env.SOLUTION_FOLDER }}")) {
            Write-Error "Solution folder not found. Please create it using 'pac solution init'."
            exit 1
          }
        shell: pwsh

      - name: Build Solution (Managed)
        run: |
          cd ${{ env.SOLUTION_FOLDER }}
          dotnet build --configuration Release /p:SolutionPackageType=Managed

      - name: Build Solution (Unmanaged)
        run: |
          cd ${{ env.SOLUTION_FOLDER }}
          dotnet build --configuration Debug /p:SolutionPackageType=Unmanaged

      - name: List build outputs
        run: |
          echo "=== Managed Solution ==="
          Get-ChildItem -Path "${{ env.SOLUTION_FOLDER }}/bin/Release" -Recurse -Filter *.zip -ErrorAction SilentlyContinue | Select-Object FullName
          echo "=== Unmanaged Solution ==="
          Get-ChildItem -Path "${{ env.SOLUTION_FOLDER }}/bin/Debug" -Recurse -Filter *.zip -ErrorAction SilentlyContinue | Select-Object FullName
        shell: pwsh

      - name: Upload Managed Solution Artifact
        uses: actions/upload-artifact@v4
        with:
          name: managed-solution
          path: ${{ env.SOLUTION_FOLDER }}/bin/Release/**/*.zip
          if-no-files-found: error
          retention-days: 30

      - name: Upload Unmanaged Solution Artifact
        uses: actions/upload-artifact@v4
        with:
          name: unmanaged-solution
          path: ${{ env.SOLUTION_FOLDER }}/bin/Debug/**/*.zip
          if-no-files-found: error
          retention-days: 30

  # ===========================================
  # Release Job - Only runs on version tags
  # ===========================================
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Managed Solution
        uses: actions/download-artifact@v4
        with:
          name: managed-solution
          path: ./artifacts/managed

      - name: Download Unmanaged Solution
        uses: actions/download-artifact@v4
        with:
          name: unmanaged-solution
          path: ./artifacts/unmanaged

      - name: Rename artifacts to avoid conflicts
        run: |
          echo "=== Renaming Artifacts ==="
          for file in ./artifacts/managed/*.zip; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .zip)
              mv "$file" "./artifacts/managed/${filename}_managed.zip"
              echo "Renamed: $file -> ./artifacts/managed/${filename}_managed.zip"
            fi
          done
          for file in ./artifacts/unmanaged/*.zip; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .zip)
              mv "$file" "./artifacts/unmanaged/${filename}_unmanaged.zip"
              echo "Renamed: $file -> ./artifacts/unmanaged/${filename}_unmanaged.zip"
            fi
          done

      - name: List downloaded artifacts
        run: |
          echo "=== Downloaded Artifacts ==="
          find ./artifacts -type f -name "*.zip"

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        run: |
          cat << 'EOF' > release_notes.md
          ## What's Changed

          ### Azure Maps Address Autocomplete v${{ steps.version.outputs.VERSION }}

          This release includes:
          - **Managed Solution** - For production environments
          - **Unmanaged Solution** - For development environments

          ### Installation
          1. Download the appropriate solution ZIP file
          2. Import into your Power Platform environment
          3. Configure the Azure Maps subscription key

          ### Requirements
          - Power Platform environment
          - Azure Maps subscription key
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Azure Maps Address Autocomplete v${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          files: |
            ./artifacts/managed/*.zip
            ./artifacts/unmanaged/*.zip
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
          generate_release_notes: true
          append_body: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}